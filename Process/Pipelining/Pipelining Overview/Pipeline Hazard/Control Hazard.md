-----
### 제어 해저드 (Control Hazard)
-----
1. 분기 해저드(Branch Hazard)라고도 하며, 인출한 명령어가 필요한 명령어가 아니므로 적절한 명령어가 적절한 클럭 사이클에 실행될 수 없는 사건으로, 명령어 주소의 흐름이 파이프라인이 기대한 것과 다르므로 발생
2. 즉, 다른 명령어들이 실행되는 동안 어떤 명령어의 결과에 기반을 둔 결정할 필요가 있을 때 일어남
   - 어떤 세탁소 점원에게 축구팀의 유니폼을 세탁하는 임무가 할당
   - 세탁물이 더러운 정도에 맞춰 세제 농도와 물 온도를 결정해서 때는 잘 빠지지만, 옷감이 상할 정도는 아니게 해야 함
     + 세탁소 파이프라인에서 세탁기 설정을 바꿀 필요가 있는지, 없는지를 결정하려면 두 번째 단계까지 기다려서 마른 유니폼을 조사해야함

3. 해결책 : 지연
   - 첫 번째 묶음이 건조될 때까지 그냥 순차적으로 작업하되, 올바른 배합이 될 때까지 반복
   - 보수적인 방법이므로 동작하는 것은 확실하지만 느림
   - 컴퓨터에서 이러한 결정 작업에 해당하는 것이 바로 조건부 분기 명령
     + 분기 명령어 다음에 실행할 명령어를 바로 다음 클럭 사이클에 인출해야함
     + 그러나 파이프라인은 다음 명령어가 어느 것이 되어야 할지 알 수 없음
     + 방금 메모리에서 분기 명령어를 받았을 뿐이므로, 분기 명령어를 가져온 직후 지연시켜서, 파이프라인이 분기의 결과를 판단하고 어느 주소에서 다음 명령어를 가져올 지 알게 될 때까지 기다리게 하는것

   - 파이프라인의 두 번째 단계에서 레지스터를 테스트하고, 분기 주소를 계산하고 PC 값을 바꿀 수 있는 하드웨어를 충분히 추가했다고 가정
     + 이렇게 충분한 하드웨어가 있어도 조건부 분기가 포함된 프로그램을 실행하는 파이프라인은 다음과 같음
<div align="center">
<img src="https://github.com/user-attachments/assets/86a3bbfe-367f-4f56-9e35-f2d66ff5a15a">
</div>

<div align="center">
<img src="https://github.com/user-attachments/assets/174da45d-cb0a-4a14-8f12-9ab3b09c531b">
</div>

   - 보다시피 lw 명령어는 분기가 실패했을 때 실행되는데도 지연을 택할 경우 200 ps 클럭 사이클 동안 지연된 후 시작

4. 예) 분기 시 지연(Stall on Branch) 성능
   - 분기 명령어가 나오면 무조건 지연시키는 방법이 CPI에 미치는 영향 (모든 명령어의 CPI는 1이라고 가정)
   - 분기 명령어가 SPECint2006에서 실행되는 명령어의 17%로, 다른 명령어들은 CPI가 1이고, 분기 명령어는 지연 때문에 한 클럭 사이클이 더 필요하여 CPI가 2가 됨
   - 따라서, 전체 CPI 값은 1.17이 되고, 이상적인 경우와 비교하면 1.17배 속도 저하가 생김

5. 파이프라인이 긴 경우에 흔히 그렇듯이 분기를 두 번째 단계에서 다 해결하지 못한다면 분기 명령어마다 지연시키는 것은 훨씬 더 큰 속도 저하를 초래할 것
6. 두 번쨰 해결책 : 예측
   - 유니폭 세탁에 적절한 배합을 잘 알고 있다고 확신한다면, 첫 번째 묶음이 건조될 때까지 기다리는 동안 배합을 예측해 두 번째 묶음을 세탁
   - 이 바법은 예측이 맞으면 파이프라인 성능을 떨어트리지 않지만, 예측이 틀리면 다시 세탁해야 함
   - 대부분의 컴퓨터가 분기 명령어를 다루기 위해 에측을 사용
     + 간단한 방법은 분기가 항상 실패한다고 예측하는 것 : 예측이 맞으면 파이프라인은 최고 속도로 진행되고, 실제로 분기가 일어날 때만 파이프라인이 지연
<div align="center">
<img src="https://github.com/user-attachments/assets/174da45d-cb0a-4a14-8f12-9ab3b09c531b">
</div>

   - 좀 더 정교한 분기 예측(Branch PredicatioN)은 어떤 경우는 분기한다고(Taken) 예측하고, 어떤 경우는 분기하지 않는다고(Untaken) 예측
     + 즉, 짙은 색 유니폼(즉, 측구의 홈 경기 유니폼)을 한 가지 배합으로 빨고, 밝은 색 유니폼(즉, 축구의 원정 경기 유니폼)을 또 다른 배합으로 빠는 것
     + 프로그램의 경우 순환문의 끝에는 순환문의 꼭대기로 점프하라는 분기 명령어가 존재하는데, 이 명령어들은 분기가 일어날 가근엇이 높고 분기 방향이 후방(Backward)이므로, 이에 착안해 현재 위치보다 작은 주소로 점프하는 분기 명령어는 항상 일어난다고 예측 가능

   - 이러한 분기 예측 방법들은 보편적 행동에 의존하며, 특정 분기 명령어의 개별성은 고려하지 않음
   - 동적 하드웨어 예측기(Dynamic Hardware Predictor)는 이와는 정반대로 개별 분기 명령어의 행동에 의존하는 예측을 하며, 프로그램이 진행되는 도중에 예측을 바꿀 수 있음
     + 즉, 유니폼이 과거에 얼마나 더러웠는지 찾아봐서 적절한 배합을 추측하고, 최근 예측의 성공 여부에 따라 다음 예측을 조정

   - 분기의 동적 에측에 널리 쓰이는 방법 중 하나는 각 분기가 일어났는지, 안 일어났는지 이력을 기록하고, 최근의 과거 이력을 사용해 미래를 예측
     + 유지되는 이력의 양이나 정보의 종류가 많아져서 최근 동적 분기 예측기는 90%의 정확도를 가지고 있음
     + 예측이 어긋났을 때는 잘못 예측한 분기 명령어 뒤에 나오는 명령어들을 무효화하고, 올바른 분기 주소로부터 파이프라인을 다시 시작해야 함
     + 즉, 세탁물에서는 잘못 예측한 세탁물을 다시 빨 수 있도록 새로운 세탁물을 받아들이는 것을 중지해야 함

7. 제어 해저드에 대한 다른 모든 해결책에서와 마찬가지로 분기 예측에서도 긴 파이프라인은 문제를 악화시킴
   - 분기 예측에서는 틀린 예측의 대가가 커지는 문제가 발생

8. 세 번쨰 해결책 : 지연 결정(Delayed Decision)
   - 세탁물에 대해 그런 결정을 하려할 때마다, 축구 유니폼이 건조되기를 기다리는 동안 축구와 관련 없는 빨래 뭉치를 세탁기에다 넣는 것
     + 테스트에 의해 영향 받지 않는 더러운 옷을 충분히 가지고 있는 한 이 같은 해결책은 제대로 동작
   - 컴퓨터에서는 지연 분기(Delayed Branch)라 불리는 해결책이 MIPS 구조에서 실제로 사용되는 방법
     + 지연 분기는 분기 명령어 다음의 명령어를 항상 실행하고, 실제 분기는 그 명령어를 파이프라인에 넣고 한 사이클 늦게 일어남
     + 프로그래머가 원하는 대로 분기할 수 있도록 어셈블러가 명령어들을 자동적으로 정렬할 수 있으므로 MIPS 어셈블리 언어 프로그래머한테는 이 특성이 보이지 않음
     + MIPS 소프트웨어는 분기 명령어에 의해 영향받지 않는 명령어를 지연 분기 명령어 바로 다음에 옮겨 놓으며, 분기 명령어는 이 안전한 명령어의 이동을 고려하여 분기 주소를 변경하게 됨
<div align="center">
<img src="https://github.com/user-attachments/assets/394dee54-8f24-4bad-a29e-00a92acc4fb7">
</div>

   - 분기 명령어 직전의 add 명령어는 분기 명령어에 영향을 주지 않으므로 분기 지연을 완전히 감추기 위해 분기 명령어 뒤로 옮길 수 있음
   - 지연 분기가 분기 지연이 작을 때 효용이 있으므로, 한 사이클보다 큰 지연 분기를 사용하는 프로세서는 없음
   - 더 긴 분기 지연에는 하드웨어 기반 분기 예측이 사용
